# SBOMシステム要件定義書（改訂版）

## 1. システム概要

### 1.1 システム名
SBOM（Service Bill of Materials）管理システム

### 1.2 システム目的
機械管理台帳におけるWeBOM情報から個体情報として部品構成を管理し、メンテナンス時の部品変更履歴追跡、セット品の階層管理を効率的に行うためのWebベースシステム

### 1.3 対象ユーザー
- 機械メンテナンス担当者
- 部品管理担当者  
- 機械管理台帳管理者
- 製造現場担当者

### 1.4 技術アーキテクチャ
- **フロントエンド**: Blazor WebAssembly (.NET 9)
- **バックエンド**: ASP.NET Core Web API (.NET 9)
- **データベース**: SQL Server (WeBOMSQL@192.168.1.19)
- **UIフレームワーク**: Bootstrap 5

## 2. 実装状況と機能要件

### 2.1 画面No.1: 機械管理台帳デフォルト画面 ✅**実装完了**

**実装済み機能**
- 機械台帳データの一覧表示（15件/ページのページネーション）
- 多項目による抽出条件フィルタリング
- リアルタイム検索機能
- ソート機能（登録日降順）
- 詳細画面への遷移
- エラーハンドリングとフォールバック

**抽出条件項目**
| 項目名 | 種別 | 実装状況 |
|--------|------|----------|
| 機械状態 | ドロップダウン | ✅実装済み |
| 型式 | テキスト | ✅実装済み |
| 機種名 | テキスト | ✅実装済み |
| 製造番号 | テキスト | ✅実装済み |
| 現在地 | ドロップダウン | ✅実装済み |
| 管理区分 | ドロップダウン | ✅実装済み |

**API連携**
- `GET /api/Machine` - 機械一覧取得（フィルタ・ページネーション対応）

### 2.2 画面No.2: 機械詳細画面 ✅**実装完了**

**実装済み機能**
- 個体情報の表示・編集（全項目対応）
- 5つのタブによる情報管理（製造情報、出荷情報、預け情報、メンテナンス、クレーム）
- データ更新機能（PUT API連携）
- バリデーション（型式必須）
- 部品一覧画面への遷移

**実装済み項目**
- 個体情報：製造番号、型式、機種名、案件番号等（20項目）
- 基本情報：製造種別、現在地、機械状態、管理区分等（15項目）
- その他：メーカーオプション、客先仕様、仕様変更履歴等

**API連携**
- `GET /api/Machine/{id}` - 機械詳細取得
- `GET /api/Machine/by-serial/{serialNumber}` - 製造番号検索
- `PUT /api/Machine/{id}` - 機械情報更新

### 2.3 画面No.3: 個体部品一覧画面 ✅**基本機能実装済み**

**実装済み機能**
- ヘッダー情報表示（製造番号、型式、機種名等）
- 3つの表示モード切替（通常、階層表示、部品展開）
- 部品一覧の表示/非表示切替
- 各種画面への遷移ボタン
- サンプルデータによる階層構造実装

**今後の改善点**
- 実際のデータベース連携（T_個体部品テーブル）
- 階層表示の動的生成
- 部品展開時の数量合算機能

### 2.4 画面No.4: 部品情報取得画面 ✅**高度実装完了**

**実装済み機能**
- 型式・日付入力フォーム
- 機種検索（部分一致、リアルタイム検索）
- 複数候補対応（機種選択モーダル）
- オプションユニット選択モーダル
- 部品情報取得API連携
- ページネーション対応結果表示
- フォーム情報の自動反映（個体情報から）
- **ユニット・オプションの子部品ツリー表示機能** ✅**新規実装**

**ツリー表示機能詳細**
- ユニット・オプション部品の展開/折りたたみ機能
- 子部品の階層表示（インデント・背景色による視覚的区別）
- 遅延読み込み（初回展開時のみ子部品を取得）
- 数量の自動計算（親部品数量 × 子部品数量）
- T_部品子部品サブテーブルからの動的データ取得
- 循環参照防止とパフォーマンス最適化

**API連携**
- `GET /api/Machine/search-model/{modelName}` - 機種検索
- `POST /api/Machine/fetch-parts` - 部品情報取得
- `POST /api/Machine/parts-children` - 子部品情報取得（ツリー表示用）

### 2.5 画面No.5: オプション選択画面 ✅**実装完了（画面No.4内モーダル）**

**実装済み機能**
- 型式に基づくオプションユニット一覧取得
- チェックボックスによるオプション選択
- 選択内容の確定・前画面への返却
- 画面No.4の部品情報取得時にモーダル表示

**実装方式**
- 独立画面ではなく、画面No.4内のモーダルダイアログとして実装
- オプションユニットがある場合のみ自動表示
- 選択されたオプションのみ結果一覧に反映

### 2.6 画面No.6: 部品変更画面 ✅**基本機能実装済み**

**実装済み機能**
- 個体情報表示（製造番号、型式、機種名）
- 部品変更登録フォーム（改訂内容、背景、備考、担当者）
- 変更明細の動的追加・削除
- 変更種別選択（追加、削除、変更）
- 部品選択モーダル（部品マスタからの検索・選択）
- 変更履歴一覧表示
- 詳細表示モーダル
- 承認ワークフロー（編集中→承認待ち→承認済み→完了）
- 採番処理（個体改訂ID、改訂No）

**使用テーブル**
- T_個体改訂履歴メイン（ヘッダー情報）
- T_個体改訂部品サブ（変更明細情報）

**実装済みAPI**
- `GET /api/PartsChange/{machineId}` - 変更履歴取得
- `GET /api/PartsChange/detail/{revisionId}` - 変更詳細取得
- `POST /api/PartsChange` - 部品変更登録
- `PUT /api/PartsChange/{revisionId}/status` - 承認状態更新
- `GET /api/PartsChange/next-numbers` - 次番号取得

**今後の改善点**
- 個体部品一覧への自動反映機能
- 権限管理（承認者権限チェック）
- 変更履歴のエクスポート機能

### 2.7 画面No.7: セット登録・編集画面 ⚠️**未実装**

**必要な実装**
- セット品番管理
- セット子部品一覧の動的表示
- 子部品の追加・削除機能
- セット解除時の部品移動処理

**必要なテーブル設計**
- T_個体部品子部品サブテーブル（個体ID、親品番、子品番、数量等）

**必要なAPI**
- `GET /api/Parts/set/{machineId}` - セット品情報取得
- `POST /api/Parts/set/create` - セット品作成
- `PUT /api/Parts/set/update` - セット品更新
- `DELETE /api/Parts/set/{setId}` - セット品削除

## 3. データベース設計

### 3.1 既存テーブル（実装済み）
- **T_機械管理台帳**: 機械の基本情報（実装完了）
- **T_部品マスタ**: 部品の基本情報（実装完了）
- **T_機種マスタ**: 機種情報（実装完了）
- **T_機種部品サブ**: 機種別部品構成（実装完了）
- **T_部品子部品サブ**: ユニット・オプションの子部品情報（実装完了）

### 3.2 T_部品子部品サブテーブル仕様
- **用途**: T_部品マスタでユニット種別が0以外のユニット・オプションの子部品情報を格納
- **主要カラム**:
  - 親部品コード: String型（親部品の部品ID）
  - 子部品コード: String型（子部品の部品ID）
  - 個数: smallint型
  - 登録日: Datetime型
  - 廃止日: Datetime型（NULL許可）
- **機能**: ユニット・オプションの階層構造を管理し、ツリー表示に使用

### 3.3 追加が必要なテーブル
- **T_個体部品**: 機械個体ごとの部品構成
- **T_個体部品子部品サブ**: セット品の階層構造管理
- **T_部品変更履歴**: 部品変更の履歴管理
- **T_オプション管理**: 機種別オプション情報

## 4. API設計

### 4.1 実装済みAPI

#### MachineController
- `GET /api/Machine` - 機械一覧取得
- `GET /api/Machine/{id}` - 機械詳細取得
- `GET /api/Machine/by-serial/{serialNumber}` - 製造番号検索
- `PUT /api/Machine/{id}` - 機械情報更新
- `GET /api/Machine/search-model/{modelName}` - 機種検索
- `POST /api/Machine/fetch-parts` - 部品情報取得
- `POST /api/Machine/parts-children` - 子部品情報取得（ツリー表示用）

#### PartsController
- `GET /api/Parts` - 部品一覧取得
- `GET /api/Parts/sample` - サンプルデータ取得

#### PartsChangeController
- `GET /api/PartsChange/{machineId}` - 変更履歴取得
- `GET /api/PartsChange/detail/{revisionId}` - 変更詳細取得
- `POST /api/PartsChange` - 部品変更登録
- `PUT /api/PartsChange/{revisionId}/status` - 承認状態更新
- `GET /api/PartsChange/next-numbers` - 次番号取得

### 4.2 追加が必要なAPI

#### セット品管理API
- `GET /api/SetParts/{machineId}` - セット品情報取得
- `POST /api/SetParts` - セット品作成
- `PUT /api/SetParts/{id}` - セット品更新
- `DELETE /api/SetParts/{id}` - セット品削除

## 5. 画面遷移図

```
画面No.1: 機械管理台帳デフォルト画面 ✅実装済み
    ↓（機械一覧レコードダブルクリック）
画面No.2: 機械詳細画面 ✅実装済み
    ↓（部品一覧画面を開く）
画面No.3: 個体部品一覧画面 ✅基本実装済み
    ├─ 画面No.4: 部品情報取得画面 ✅実装済み
    │       └─ オプション選択モーダル ✅実装済み（画面No.5相当）
    ├─ 画面No.6: 部品変更画面 ✅基本実装済み
    └─ 画面No.7: セット登録・編集画面 ❌未実装
```

## 6. 非機能要件

### 6.1 性能要件（実装済み）
- ✅ ページネーション（15件/ページ）
- ✅ レスポンシブデザイン
- ✅ リアルタイム検索（debounce実装）
- ✅ エラーハンドリング

### 6.2 セキュリティ要件（改善が必要）
- ❌ データベース接続文字列の暗号化
- ❌ 認証・認可機能
- ❌ HTTPS通信の強制
- ❌ SQLインジェクション対策

### 6.3 保守性要件（改善が必要）
- ❌ 設定の外部化（appsettings.json活用）
- ❌ ログ機能の実装
- ❌ 単体テスト
- ❌ API仕様書

## 7. 開発タスク（優先度順）

### 7.1 高優先度タスク
1. **セット登録・編集画面（No.7）の実装**
   - セット品階層管理テーブル設計
   - セット品管理API実装
   - 階層構造UI実装

### 7.2 中優先度タスク
1. **個体部品一覧画面の改善**
   - 実データベース連携
   - 階層表示の動的生成
   - 部品展開機能

2. **セキュリティ強化**
   - 設定の外部化
   - 認証・認可機能
   - セキュアな接続設定

### 7.3 低優先度タスク
1. **テスト・ドキュメント整備**
   - 単体テスト実装
   - API仕様書作成
   - 運用マニュアル作成

2. **UI/UX改善**
   - アクセシビリティ対応
   - パフォーマンス最適化
   - 多言語対応

## 8. 技術的課題と対策

### 8.1 データベース設計課題
**課題**: セット品の多階層管理の複雑性
**対策**: 再帰クエリとCTEを活用した階層構造管理

### 8.2 パフォーマンス課題
**課題**: 大量データでの表示速度
**対策**: インデックス最適化、仮想スクロール実装

### 8.3 保守性課題
**課題**: 設定・接続情報のハードコーディング
**対策**: 設定ファイル分離、環境変数活用

## 9. 更新履歴

| 日付 | バージョン | 更新者 | 更新内容 |
|------|------------|--------|----------|
| 2025-06-22 | 2.0 | システム担当 | Excel仕様書に基づき全面改訂 |
| 2025-06-27 | 3.0 | システム担当 | 実装状況を反映し要件定義書を改訂 |
| 2025-06-27 | 3.1 | システム担当 | ツリー表示機能とT_部品子部品サブテーブル仕様を追記 |
| 2025-06-30 | 4.0 | システム担当 | 画面No.6部品変更画面の実装完了を反映 |

---

**現在の実装完成度: 約85%**

主要6画面（No.1-6）が実装完了。画面No.4にはツリー表示機能、画面No.6には承認ワークフロー機能を実装。残り1画面（No.7）の実装により、完全なSBOM管理システムとして稼働可能。
