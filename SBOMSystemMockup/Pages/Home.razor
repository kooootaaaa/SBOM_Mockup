@page "/"
@using System.Text.Json
@inject HttpClient Http

<PageTitle>機械管理台帳</PageTitle>

<h1>機械管理台帳 <small class="text-muted">（画面No.1 - Home.razor）</small></h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>データベース接続エラー:</strong> @errorMessage
        <br/>現在はサンプルデータを表示しています。
    </div>
}

<div class="mb-3">
    <label class="me-2"><input type="checkbox" @bind="filterCompleted" /> 完成</label>
    <label class="me-2"><input type="checkbox" @bind="filterUnshipped" /> 未出荷</label>
    <label class="me-2"><input type="checkbox" @bind="filterInStock" /> 保留</label>
    <label class="me-2"><input type="checkbox" @bind="filterDemo" /> デモ機</label>
    <select class="form-select d-inline w-auto me-2" @bind="selectedSeries">
        <option value="">シリーズ選択</option>
        <option value="A">Aシリーズ</option>
        <option value="B">Bシリーズ</option>
    </select>
    <input class="form-control d-inline w-auto me-2" placeholder="型式" @bind="filterModel" />
    <input class="form-control d-inline w-auto me-2" placeholder="製造番号" @bind="filterId" />
    <button class="btn btn-primary me-2" @onclick="ApplyFilter">抽出実行</button>
    <button class="btn btn-secondary" @onclick="ClearFilter">解除</button>
</div>

<table class="table table-bordered table-sm" style="table-layout: fixed;">
    <thead>
        <tr>
            <th style="width: 10%;">製造番号</th>
            <th style="width: 12%;">型式</th>
            <th style="width: 20%;">機種名</th>
            <th style="width: 10%;">現在地</th>
            <th style="width: 8%;">機械状態</th>
            <th style="width: 6%;">預けNo.</th>
            <th style="width: 8%;">管理区分</th>
            <th style="width: 11%;">メーカーオプション</th>
            <th style="width: 11%;">客先仕様</th>
            <th style="width: 6%;">完成日</th>
            <th style="width: 8%;">操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var machine in filteredMachines)
        {
            <tr>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@machine.Id</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@machine.Model</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@machine.TypeName</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@machine.Location</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@machine.Status</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@machine.DepositNo</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@machine.ManagementType</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@machine.MakerOption">@machine.MakerOption</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@machine.CustomerSpec">@machine.CustomerSpec</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@FormatCompletionDate(machine.CompletionDate)</td>
                <td>
                    <a href="@($"/machine/{machine.ManagementId ?? machine.Id}")" class="btn btn-primary btn-sm">詳細表示</a>
                </td>
            </tr>
        }
    </tbody>
</table>

@if (totalRecords > 0)
{
    <nav aria-label="ページネーション">
        <ul class="pagination justify-content-center">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">前へ</button>
            </li>
            
            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
            {
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <button class="page-link" @onclick="() => GoToPage(i)">@i</button>
                </li>
            }
            
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">次へ</button>
            </li>
        </ul>
    </nav>
    
    <div class="text-center mt-2">
        @((currentPage - 1) * pageSize + 1) - @(Math.Min(currentPage * pageSize, totalRecords)) / @totalRecords 件
    </div>
}

@code {
    private List<Machine> machines = new();
    private List<Machine> filteredMachines = new();
    private int currentPage = 1;
    private int pageSize = 15;
    private int totalRecords = 0;
    private int totalPages = 0;
    private string errorMessage = "";
    private string apiBaseUrl = "http://localhost:5196/api";

    // 抽出条件
    private bool filterCompleted;
    private bool filterUnshipped;
    private bool filterInStock;
    private bool filterDemo;
    private string selectedSeries = "";
    private string filterModel = "";
    private string filterId = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadMachinesFromDatabase();
    }

    private async Task LoadMachinesFromDatabase()
    {
        try
        {
            var response = await Http.GetAsync($"{apiBaseUrl}/Machine?page={currentPage}&pageSize={pageSize}");
            
            if (response.IsSuccessStatusCode)
            {
                var jsonContent = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<ApiResponse>(jsonContent, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });
                
                if (result != null)
                {
                    machines.Clear();
                    foreach (var machineData in result.Machines)
                    {
                        machines.Add(new Machine
                        {
                            Id = GetStringValue(machineData, "製造番号"),
                            ManagementId = GetNullableStringValue(machineData, "機械管理ID"),
                            CompletionDate = GetStringValue(machineData, "完成日"),
                            Model = GetStringValue(machineData, "型式"),
                            TypeName = GetStringValue(machineData, "機種名"),
                            Location = GetStringValue(machineData, "現所在地"),
                            Status = GetStringValue(machineData, "機械状態"),
                            DepositNo = GetStringValue(machineData, "預けNo"),
                            ManagementType = GetStringValue(machineData, "管理区分"),
                            MakerOption = GetStringValue(machineData, "メーカーオプション"),
                            CustomerSpec = GetStringValue(machineData, "客先仕様")
                        });
                    }
                    
                    totalRecords = result.TotalRecords;
                    totalPages = result.TotalPages;
                    errorMessage = ""; // 成功時はエラーメッセージをクリア
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var errorResult = JsonSerializer.Deserialize<ErrorResponse>(errorContent, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });
                errorMessage = errorResult?.Error ?? "API呼び出しに失敗しました。";
                LoadSampleData();
            }
            
            filteredMachines = machines.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"API接続エラー: {ex.Message}";
            Console.WriteLine($"API接続エラー: {ex.Message}");
            LoadSampleData();
        }
    }
    
    private string GetStringValue(Dictionary<string, object> data, string key)
    {
        if (data.TryGetValue(key, out var value))
        {
            return value?.ToString() ?? "";
        }
        return "";
    }
    
    private string? GetNullableStringValue(Dictionary<string, object> data, string key)
    {
        if (data.TryGetValue(key, out var value) && value != null)
        {
            var strValue = value.ToString();
            return string.IsNullOrEmpty(strValue) ? null : strValue;
        }
        return null;
    }
    
    private void LoadSampleData()
    {
        machines = new List<Machine>
        {
            new Machine { Id = "1510006", CompletionDate = "15-09-17", Model = "WTD-T16I", TypeName = "トルネードT16αR", Location = "本社", Status = "高荷重機", DepositNo = "", ManagementType = "新品", MakerOption = "クレーム返却後", CustomerSpec = "" },
            new Machine { Id = "1205009", CompletionDate = "19-02-18", Model = "NF-410AD", TypeName = "グレートパンチSS2", Location = "本社", Status = "中古", DepositNo = "", ManagementType = "中古", MakerOption = "", CustomerSpec = "" },
            new Machine { Id = "23030666", CompletionDate = "22-03-09", Model = "WM-PB-PS31ST-1", TypeName = "グレートパンチSS2", Location = "本社", Status = "新品", DepositNo = "", ManagementType = "新品", MakerOption = "", CustomerSpec = "" }
        };
        filteredMachines = machines.ToList();
        totalRecords = machines.Count;
        totalPages = (int)Math.Ceiling((double)totalRecords / pageSize);
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            await LoadMachinesFromDatabase();
        }
    }

    private async Task ApplyFilter()
    {
        currentPage = 1; // フィルタ適用時は1ページ目に戻る
        await LoadMachinesFromDatabase();
        
        filteredMachines = machines.Where(m =>
            (!filterCompleted || m.Status.Contains("新品")) &&
            (!filterUnshipped || m.Status.Contains("未出荷")) &&
            (!filterInStock || m.Status.Contains("保留")) &&
            (!filterDemo || m.Status.Contains("デモ")) &&
            (string.IsNullOrEmpty(selectedSeries) || m.Model.StartsWith(selectedSeries)) &&
            (string.IsNullOrEmpty(filterModel) || m.Model.Contains(filterModel)) &&
            (string.IsNullOrEmpty(filterId) || m.Id.Contains(filterId))
        ).ToList();
    }

    private async Task ClearFilter()
    {
        filterCompleted = false;
        filterUnshipped = false;
        filterInStock = false;
        filterDemo = false;
        selectedSeries = "";
        filterModel = "";
        filterId = "";
        currentPage = 1;
        await LoadMachinesFromDatabase();
    }

    public class Machine
    {
        public string Id { get; set; } = "";
        public string? ManagementId { get; set; }
        public string CompletionDate { get; set; } = "";
        public string Model { get; set; } = "";
        public string TypeName { get; set; } = "";
        public string Location { get; set; } = "";
        public string Status { get; set; } = "";
        public string DepositNo { get; set; } = "";
        public string ManagementType { get; set; } = "";
        public string MakerOption { get; set; } = "";
        public string CustomerSpec { get; set; } = "";
    }
    
    public class ApiResponse
    {
        public List<Dictionary<string, object>> Machines { get; set; } = new();
        public int TotalRecords { get; set; }
        public int CurrentPage { get; set; }
        public int PageSize { get; set; }
        public int TotalPages { get; set; }
    }
    
    public class ErrorResponse
    {
        public string Error { get; set; } = "";
    }
    
    private string FormatCompletionDate(string dateString)
    {
        if (string.IsNullOrEmpty(dateString))
            return "";
            
        // データベースから取得した日付文字列をパースして yyyy/M/d 形式にフォーマット
        if (DateTime.TryParse(dateString, out DateTime date))
        {
            return date.ToString("yyyy/M/d");
        }
        
        return dateString; // パースできない場合は元の値を返す
    }
}
